name: Python Linting & Code Quality

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend_app/**/*.py'
      - 'scripts/**/*.py'
      - '.flake8'
      - 'requirements*.txt'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend_app/**/*.py'
      - 'scripts/**/*.py'
      - '.flake8'
      - 'requirements*.txt'

jobs:
  linting:
    name: Python Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 autopep8 black isort
        
    - name: ğŸ” Check Python syntax
      run: |
        echo "ğŸ” Verificando sintaxis Python..."
        python -m py_compile backend_app/**/*.py || {
          echo "âŒ Errores de sintaxis encontrados"
          exit 1
        }
        echo "âœ… Sintaxis Python correcta"
        
    - name: ğŸ”§ Run Flake8 (Critical Errors Only)
      run: |
        echo "ğŸ” Ejecutando Flake8 - Errores CrÃ­ticos..."
        flake8 backend_app/ --config=.flake8 --select=E999,W504,E111,E112,E113,E114,E115,E116 --statistics
        
    - name: ğŸ“Š Run Flake8 (Full Report)
      continue-on-error: true
      run: |
        echo "ğŸ“Š Reporte completo de Flake8..."
        flake8 backend_app/ --config=.flake8 --statistics --tee --output-file=flake8-report.txt
        
    - name: ğŸ“‹ Upload Flake8 Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: flake8-report
        path: flake8-report.txt
        retention-days: 30
        
    - name: ğŸ¯ Check for Critical Issues
      run: |
        echo "ğŸ¯ Verificando problemas crÃ­ticos..."
        
        # Contar errores crÃ­ticos
        CRITICAL_ERRORS=$(flake8 backend_app/ --select=E999,W504,E111,E112,E113,E114,E115,E116 --count --quiet)
        
        if [ "$CRITICAL_ERRORS" -gt 0 ]; then
          echo "âŒ $CRITICAL_ERRORS errores crÃ­ticos encontrados"
          echo "ğŸ”§ Ejecuta 'python scripts/fix-linting.py' para corregir automÃ¡ticamente"
          exit 1
        else
          echo "âœ… No se encontraron errores crÃ­ticos"
        fi
        
    - name: ğŸ“ˆ Code Quality Summary
      if: always()
      run: |
        echo "ğŸ“ˆ RESUMEN DE CALIDAD DE CÃ“DIGO"
        echo "================================"
        
        # EstadÃ­sticas generales
        TOTAL_LINES=$(find backend_app -name "*.py" -exec wc -l {} + | tail -1 | awk '{print $1}')
        TOTAL_FILES=$(find backend_app -name "*.py" | wc -l)
        
        echo "ğŸ“ Archivos Python: $TOTAL_FILES"
        echo "ğŸ“„ LÃ­neas de cÃ³digo: $TOTAL_LINES"
        
        # Errores por categorÃ­a
        echo ""
        echo "ğŸ” ERRORES POR CATEGORÃA:"
        flake8 backend_app/ --statistics --quiet | head -20 || echo "No hay errores"
        
        echo ""
        echo "âœ… VerificaciÃ³n de calidad completada"

  auto-fix:
    name: Auto-fix Linting Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: linting
    continue-on-error: true
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 autopep8 black isort
        
    - name: ğŸ”§ Auto-fix issues
      run: |
        echo "ğŸ”§ Intentando correcciÃ³n automÃ¡tica..."
        python scripts/fix-linting.py
        
    - name: ğŸ“ Commit fixes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "âœ… No hay cambios para hacer commit"
        else
          git add -A
          git commit -m "ğŸ”§ Auto-fix: Corregir errores de linting automÃ¡ticamente"
          git push
          echo "âœ… Correcciones automÃ¡ticas aplicadas"
        fi

